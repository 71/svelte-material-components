<div ref:textField {...attrs}>
  {#if icon && icon_mode === "leading"}
    <Icon class="mdc-text-field__icon" tabindex="0" role="button">{icon}</Icon>
  {/if}
  <input type="{type}" id="{id}" name="{name}" class="mdc-text-field__input" disabled={disabled} {...inputAttrs}>
  {#if hint_text}
    <label class="mdc-floating-label" for="{id}">{hint_text}</label>
  {/if}
  {#if icon && icon_mode === "trailing"}
    <Icon class="mdc-text-field__icon" tabindex="0" role="button">{icon}</Icon>
  {/if}
  {#if outlined}
    <div class="mdc-notched-outline">
      <svg>
        <path class="mdc-notched-outline__path"/>
      </svg>
    </div>
    <div class="mdc-notched-outline__idle"></div>
  {:else}
    <div class="mdc-line-ripple"></div>
  {/if}
</div>
{#if helper_text}
<p id="{id}-helper-text" class="mdc-text-field-helper-text" aria-hidden="true">
  {helper_text}
</p>
{/if}
<script>
import {MDCTextField} from "@material/textfield";

import {processAttributes, formatString} from "./helpers.js";
const mdcAttrs = ["value", "min", "max", "step", "max_length", "pattern", "required"];
export default {
    components: {
        Icon: "./Icon.html"
    },
    oncreate() {
        this.mdcComponent = new MDCTextField(this.refs.textField);
    },
    onstate({current, changed}) {
        for (let key of mdcAttrs) {
            if (changed[key]) {
                this.mdcComponent[key] = current[key];
            }
        }
        for (let key of ["icon_mode", "helper_text", "outlined", "hint_text"]) {
            if (changed[key]) {
                this.mdcComponent.destroy();
                this.mdcComponent = new MDCTextField(this.refs.textField);
                break;
            }
        }
    },
    ondestroy() {
        this.mdcComponent.destroy();
    },
    computed: {
        inputAttrs({helper_text, id}) {
            var result = {};
            if (helper_text) {
                let elem = id+"-helper-text";
                result["aria-controls"] = elem;
                result["aria-describedby"] = elem;
            }
            return result;
        },
        attrs (attributes) {
            let result = Object.assign({}, attributes);
            let cls ="mdc-text-field";
            let classes = [cls];
            for (let key of ["box", "dense", "fullwidth", "outlined", "disabled", "focused"]) {
                if (result[key]) {
                    classes.push(cls+"--"+formatString(key));
                }
                delete result[key];
            }
            if (result.icon && result.icon_mode) {
                classes.push(cls+"--with-"+result.icon_mode+"-icon");
            }
            for (let key of ["attrs", "id", "name", "type", "helper_text", "inputAttrs", "icon", "icon_mode", ...mdcAttrs]) {
                delete result[key];
            }
            if (result["class"]) {
                classes.push(result["class"]);
            }
            result["class"] = classes.join(" ");
            return processAttributes(result);
        }
    }
};
</script>
